<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <title>MouseTube</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Material Icons & Roboto Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Material Design 2 Customizations */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f9f9f9;
            color: #0f0f0f;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 60px; /* Space for bottom nav */
            overscroll-behavior-y: none;
        }

        /* Theme Colors */
        .theme-red { color: #FF0000; }
        .bg-theme-red { background-color: #FF0000; }
        .border-theme-red { border-color: #FF0000; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #FF0000;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #FF0000;
        }

        /* Utilities */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Material Ripple */
        .ripple { position: relative; overflow: hidden; transform: translate3d(0, 0, 0); }
        .ripple:after {
            content: ""; display: block; position: absolute; width: 100%; height: 100%; top: 0; left: 0; pointer-events: none;
            background-image: radial-gradient(circle, #000 10%, transparent 10.01%);
            background-repeat: no-repeat; background-position: 50%; transform: scale(10, 10); opacity: 0; transition: transform .5s, opacity 1s;
        }
        .ripple:active:after { transform: scale(0, 0); opacity: .2; transition: 0s; }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #FF0000; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Active Nav State */
        .nav-item.active { color: #FF0000; }
        .nav-item.active .material-icons { font-weight: bold; }
    </style>
</head>
<body>

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen relative shadow-2xl overflow-hidden flex flex-col">
        
        <!-- Header -->
        <header id="main-header" class="fixed top-0 w-full max-w-md z-40 bg-white/95 backdrop-blur-sm shadow-sm transition-transform duration-300">
            <div class="flex justify-between items-center px-4 h-14">
                <div class="flex items-center gap-2 cursor-pointer" onclick="renderHome()">
                    <span class="material-icons theme-red text-3xl">play_circle_filled</span>
                    <span class="font-bold text-xl tracking-tight">MouseTube</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="renderSearch()" class="material-icons text-gray-700 ripple rounded-full p-1">search</button>
                    <button onclick="renderSettings()" class="material-icons text-gray-700 ripple rounded-full p-1">settings</button>
                    <div onclick="renderMyPage()" class="w-8 h-8 rounded-full border border-gray-200 cursor-pointer overflow-hidden">
                         <img id="header-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="pt-14 flex-1 overflow-y-auto hide-scroll pb-16">
            <!-- Content injected by JS -->
        </main>

        <!-- Player Overlay -->
        <div id="player-overlay" class="fixed inset-0 bg-white z-50 transform translate-y-full transition-transform duration-300 flex flex-col shadow-2xl">
            <!-- Player content injected by JS -->
        </div>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 z-40 h-14 flex justify-around items-center">
            <button onclick="renderHome()" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-600 ripple active" data-nav="home">
                <span class="material-icons text-2xl">home</span>
                <span class="text-[10px] mt-0.5">ホーム</span>
            </button>
            <button onclick="renderShorts()" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-600 ripple" data-nav="shorts">
                <span class="material-icons text-2xl">movie</span>
                <span class="text-[10px] mt-0.5">ショート</span>
            </button>
            <button onclick="renderMyPage()" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-600 ripple" data-nav="subs">
                <span class="material-icons text-2xl">subscriptions</span>
                <span class="text-[10px] mt-0.5">登録ch</span>
            </button>
            <button onclick="renderMyPage()" class="nav-item flex flex-col items-center justify-center w-full h-full text-gray-600 ripple" data-nav="mypage">
                <span class="material-icons text-2xl">person</span>
                <span class="text-[10px] mt-0.5">マイページ</span>
            </button>
        </nav>

    </div>

    <!-- JavaScript Application Logic -->
    <script>
        // --- Configuration & State ---
        const CONFIG = {
            appName: 'MouseTube',
            dbName: 'MouseTubeDB',
            dbVersion: 2
        };

        let state = {
            apiKey: localStorage.getItem('mt_api_key') || '',
            economyMode: localStorage.getItem('mt_economy_mode') !== 'false',
            user: { 
                name: 'ゲスト', 
                handle: '@guest', 
                avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Guest' 
            },
            currentTab: 'home'
        };

        // --- IndexedDB Wrapper ---
        const db = {
            db: null,
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CONFIG.dbName, CONFIG.dbVersion);
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        const stores = ['history', 'likes', 'subscriptions', 'searchHistory', 'userProfile'];
                        stores.forEach(name => {
                            if (!db.objectStoreNames.contains(name)) {
                                db.createObjectStore(name, { keyPath: name === 'userProfile' ? 'key' : (name === 'searchHistory' ? 'query' : (name === 'subscriptions' ? 'channelId' : 'videoId')) });
                            }
                        });
                    };

                    request.onsuccess = (e) => {
                        this.db = e.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (e) => reject(e);
                });
            },
            async put(storeName, data) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    // Clone to avoid modifying original
                    const item = JSON.parse(JSON.stringify(data));
                    item.timestamp = Date.now();
                    tx.objectStore(storeName).put(item);
                    tx.oncomplete = () => resolve();
                    tx.onerror = (e) => reject(e);
                });
            },
            async get(storeName, key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const req = tx.objectStore(storeName).get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            },
            async getAll(storeName) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readonly');
                    const request = tx.objectStore(storeName).getAll();
                    request.onsuccess = () => resolve(request.result.sort((a, b) => b.timestamp - a.timestamp));
                    request.onerror = (e) => reject(e);
                });
            },
            async delete(storeName, key) {
                if (!this.db) await this.init();
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(storeName, 'readwrite');
                    tx.objectStore(storeName).delete(key);
                    tx.oncomplete = () => resolve();
                });
            }
        };

        // --- API Helpers ---
        const API = {
            baseUrl: 'https://www.googleapis.com/youtube/v3',
            
            async search(query, type = 'video') {
                if (!state.apiKey) return this.getMockData(type);
                try {
                    const url = `${this.baseUrl}/search?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=${type}&key=${state.apiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.items || [];
                } catch (e) {
                    console.error("API Error", e);
                    return this.getMockData(type);
                }
            },
            
            async getRecommendations() {
                if (state.economyMode) {
                    const history = await db.getAll('history');
                    if (history.length > 0) {
                        return history.sort(() => 0.5 - Math.random()).slice(0, 20);
                    }
                    return this.getMockData('video'); 
                }
                
                if (!state.apiKey) return this.getMockData('video');
                try {
                    const url = `${this.baseUrl}/videos?part=snippet,statistics&chart=mostPopular&regionCode=JP&maxResults=20&key=${state.apiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    return data.items || this.getMockData('video');
                } catch(e) { return this.getMockData('video'); }
            },

            async getChannelVideos(channelId) {
                if (state.economyMode || !state.apiKey) return this.getMockData('video').map(v => ({...v, snippet: {...v.snippet, channelId}}));
                try {
                     const url = `${this.baseUrl}/search?part=snippet&channelId=${channelId}&order=date&maxResults=5&type=video&key=${state.apiKey}`;
                     const res = await fetch(url);
                     const data = await res.json();
                     return data.items || [];
                } catch(e) { return []; }
            },

            async getComments(videoId) {
                if (state.economyMode) return [];
                if (!state.apiKey) return [];
                try {
                    const res = await fetch(`${this.baseUrl}/commentThreads?part=snippet&videoId=${videoId}&maxResults=10&key=${state.apiKey}`);
                    const data = await res.json();
                    return data.items || [];
                } catch(e) { return []; }
            },

            getMockData(type) {
                const mocks = [];
                const mockTitles = [
                    "MouseTubeへようこそ！", "癒やしの猫動画", "絶景！世界の旅", 
                    "プログラミング入門", "最新ガジェットレビュー", "ASMR 睡眠用", 
                    "ゲーム実況ハイライト", "簡単クッキング"
                ];
                for(let i=0; i<10; i++) {
                    mocks.push({
                        id: { videoId: `mock_${Math.random().toString(36).substr(2,9)}`, channelId: `ch_${i}` },
                        snippet: {
                            title: mockTitles[i % mockTitles.length],
                            channelTitle: `クリエイター ${i}`,
                            thumbnails: { high: { url: `https://picsum.photos/seed/${i+Date.now()}/480/270` }, medium: { url: `https://picsum.photos/seed/${i}/320/180` }, default: { url: `https://picsum.photos/seed/${i}/120/90` } },
                            publishedAt: new Date().toISOString(),
                            description: "API節約モードON、またはAPIキー未設定のためダミーデータを表示しています。"
                        }
                    });
                }
                return mocks;
            }
        };

        // --- UI Rendering ---
        const mainContent = document.getElementById('main-content');
        const playerOverlay = document.getElementById('player-overlay');
        const headerAvatar = document.getElementById('header-avatar');

        function setActiveNav(navId) {
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                if(el.dataset.nav === navId) el.classList.add('active');
            });
        }

        // 1. Home Screen
        async function renderHome() {
            closePlayer();
            setActiveNav('home');
            state.currentTab = 'home';
            
            const ecoBanner = state.economyMode ? 
                `<div class="bg-blue-50 text-blue-800 text-xs py-1 px-4 text-center border-b border-blue-100">
                    現在「API節約モード」です。おすすめは履歴から表示されます。
                 </div>` : '';

            mainContent.innerHTML = `
                ${ecoBanner}
                <div class="space-y-2">
                    <!-- Top Categories -->
                    <div class="flex overflow-x-auto hide-scroll px-4 py-3 gap-4 border-b border-gray-100 bg-white">
                         <div class="flex flex-col items-center min-w-[60px]" onclick="renderMyPage()">
                            <div class="w-14 h-14 rounded-full border-2 border-red-500 p-0.5">
                                <img src="${state.user.avatar}" class="w-full h-full rounded-full bg-gray-100 object-cover">
                            </div>
                            <span class="text-xs mt-1 truncate w-14 text-center">あなた</span>
                        </div>
                        ${[1,2,3].map(i => `
                        <div class="flex flex-col items-center min-w-[60px]">
                            <div class="w-14 h-14 rounded-full border-2 border-gray-200 p-0.5 grayscale opacity-70">
                                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${i}" class="w-full h-full rounded-full bg-gray-100">
                            </div>
                            <span class="text-xs mt-1 text-center">Ch.${i}</span>
                        </div>`).join('')}
                    </div>

                    <!-- Filter Tags -->
                    <div class="flex overflow-x-auto hide-scroll px-4 py-2 gap-2 sticky top-0 bg-white/95 z-30 backdrop-blur pb-3 border-b border-gray-100">
                        <button class="chip px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-900 text-white whitespace-nowrap">すべて</button>
                        <button class="chip px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-800 whitespace-nowrap border border-gray-200">ライブ</button>
                        <button class="chip px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-800 whitespace-nowrap border border-gray-200">ゲーム</button>
                        <button class="chip px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-100 text-gray-800 whitespace-nowrap border border-gray-200">音楽</button>
                    </div>

                    <!-- Video Feed -->
                    <div id="video-feed" class="pb-4">
                        <div class="flex justify-center p-4"><div class="loader"></div></div>
                    </div>
                </div>
            `;

            const videos = await API.getRecommendations();
            const feedContainer = document.getElementById('video-feed');
            feedContainer.innerHTML = '';
            
            if(videos.length === 0) {
                 feedContainer.innerHTML = `<div class="text-center p-10 text-gray-500">
                    <span class="material-icons text-4xl mb-2">history</span><br>
                    視聴履歴がありません。<br>検索して動画を見てみましょう。
                 </div>`;
            } else {
                videos.forEach(video => {
                    const el = createVideoCard(video);
                    feedContainer.appendChild(el);
                });
            }
        }

        // Helper: Create Video Card
        function createVideoCard(video, isHorizontal = false) {
            const vid = video.id?.videoId || video.id || video.videoId;
            const snippet = video.snippet;
            
            // Safety check for valid video
            if (!vid || !snippet) return document.createElement('div');

            const div = document.createElement('div');
            
            const thumb = snippet.thumbnails?.high?.url || snippet.thumbnails?.medium?.url || snippet.thumbnails?.default?.url || 'https://via.placeholder.com/320x180';
            const title = snippet.title || 'No Title';
            const channel = snippet.channelTitle || 'Unknown';

            if (isHorizontal) {
                 div.className = "flex gap-3 p-3 bg-white mb-2 shadow-sm rounded-lg mx-2 video-card cursor-pointer ripple border border-gray-50";
                 div.innerHTML = `
                    <div class="relative w-40 flex-shrink-0">
                        <img src="${thumb}" class="w-full h-24 object-cover rounded-md bg-gray-200" onerror="this.src='https://via.placeholder.com/160x90'">
                    </div>
                    <div class="flex flex-col flex-1 min-w-0 justify-center">
                        <h3 class="list-title line-clamp-2 mb-1 text-sm font-medium text-gray-900">${title}</h3>
                        <div class="text-xs text-gray-500">
                            <p>${channel}</p>
                            <p>${timeSince(snippet.publishedAt)}</p>
                        </div>
                    </div>
                 `;
            } else {
                div.className = "flex flex-col bg-white mb-2 shadow-sm video-card cursor-pointer ripple";
                div.innerHTML = `
                    <div class="relative w-full aspect-video">
                        <img src="${thumb}" class="w-full h-full object-cover bg-gray-200" onerror="this.src='https://via.placeholder.com/320x180'">
                        <span class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">--:--</span>
                    </div>
                    <div class="flex p-3 gap-3">
                        <div class="w-9 h-9 flex-shrink-0 rounded-full bg-gray-200 overflow-hidden">
                             <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${snippet.channelId}" class="w-full h-full">
                        </div>
                        <div class="flex flex-col flex-1 min-w-0">
                            <h3 class="list-title line-clamp-2 leading-tight mb-1 text-sm font-medium text-gray-900">${title}</h3>
                            <div class="text-xs text-gray-500">
                                <span>${channel}</span> • <span>${timeSince(snippet.publishedAt)}</span>
                            </div>
                        </div>
                        <button class="material-icons text-gray-400 text-lg self-start p-1">more_vert</button>
                    </div>
                `;
            }

            // Explicitly set click handler
            div.onclick = (e) => {
                e.stopPropagation(); // Prevent bubbling issues
                openPlayer(video);
            };
            
            return div;
        }

        // 2. Shorts Screen
        async function renderShorts() {
            closePlayer();
            setActiveNav('shorts');
            mainContent.innerHTML = `
                <div class="h-full bg-black flex items-center justify-center text-white">
                    <div class="text-center">
                        <span class="material-icons text-5xl mb-4">phonelink_erase</span>
                        <p>ショート動画はAPI制限のため<br>現在サポート外です</p>
                    </div>
                </div>
            `;
        }

        // 3. Search Screen
        async function renderSearch() {
            closePlayer();
            mainContent.innerHTML = `
                <div class="bg-white min-h-screen">
                    <div class="flex items-center gap-2 p-2 border-b sticky top-0 bg-white z-10">
                        <button onclick="renderHome()" class="material-icons text-gray-600 p-2 ripple rounded-full">arrow_back</button>
                        <div class="flex-1 bg-gray-100 rounded-full flex items-center px-3 py-1.5">
                            <input id="search-input" type="text" placeholder="YouTubeを検索" class="bg-transparent w-full outline-none text-base" onkeydown="handleSearchKey(event)">
                        </div>
                        <button onclick="performSearch()" class="material-icons text-gray-600 p-2 bg-gray-100 rounded-full ripple">search</button>
                    </div>
                    
                    <div id="search-history" class="p-2"></div>
                    <div id="search-results" class="p-2 hidden"></div>
                </div>
            `;
            
            const history = await db.getAll('searchHistory');
            const historyContainer = document.getElementById('search-history');
            if(history.length) {
                historyContainer.innerHTML = '<p class="text-xs font-bold text-gray-500 px-2 mb-2">検索履歴</p>';
                history.slice(0, 10).forEach(h => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded cursor-pointer ripple";
                    div.innerHTML = `
                        <div class="flex items-center gap-3 flex-1 overflow-hidden" onclick="fillSearch('${h.query}')">
                            <span class="material-icons text-gray-400">history</span>
                            <span class="text-base truncate">${h.query}</span>
                        </div>
                        <span class="material-icons text-gray-400 text-lg -rotate-45">arrow_upward</span>
                    `;
                    historyContainer.appendChild(div);
                });
            } else {
                historyContainer.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">履歴はありません</div>';
            }
            document.getElementById('search-input').focus();
        }

        function fillSearch(txt) {
            document.getElementById('search-input').value = txt;
            performSearch();
        }

        function handleSearchKey(e) { if(e.key === 'Enter') performSearch(); }

        async function performSearch() {
            const query = document.getElementById('search-input').value;
            if(!query) return;

            await db.put('searchHistory', { query: query });

            const historyDiv = document.getElementById('search-history');
            const resultsDiv = document.getElementById('search-results');
            
            historyDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';

            const results = await API.search(query, 'video'); // Explicitly ask for videos
            resultsDiv.innerHTML = '';
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="text-center p-8 text-gray-500">検索結果が見つかりませんでした</div>';
                return;
            }

            results.forEach(video => {
                const el = createVideoCard(video, true);
                resultsDiv.appendChild(el);
            });
        }

        // 4. My Page
        async function renderMyPage() {
            closePlayer();
            setActiveNav('mypage');
            
            const history = await db.getAll('history');
            const subs = await db.getAll('subscriptions');

            mainContent.innerHTML = `
                <div class="pb-10">
                    <!-- Profile Header -->
                    <div class="flex items-center gap-4 p-5 bg-white border-b border-gray-100">
                        <div class="w-16 h-16 rounded-full border border-gray-200 p-0.5 overflow-hidden">
                            <img src="${state.user.avatar}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <h2 class="font-bold text-xl">${state.user.name}</h2>
                            <p class="text-gray-500 text-sm">${state.user.handle}</p>
                            <button class="mt-2 text-xs border border-gray-300 rounded-full px-3 py-1 font-medium ripple" onclick="renderSettings()">アカウント設定</button>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="mt-4 bg-white p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg">履歴</h3>
                            <button class="text-blue-600 text-sm font-medium">すべて表示</button>
                        </div>
                        <div class="flex overflow-x-auto gap-3 hide-scroll pb-2">
                            ${history.length ? '' : '<p class="text-gray-400 text-sm">視聴履歴はありません</p>'}
                            <!-- History Click Handler Note: Using onclick in HTML string requires escaping. But for simplicity here, we render via JS loop below to attach clean events if needed, but string injection with openPlayer works if video object structure is safe. -->
                            ${history.map(h => {
                                // Safe escape for HTML attribute
                                const json = JSON.stringify(h).replace(/"/g, '&quot;');
                                const thumb = h.snippet.thumbnails?.medium?.url || 'https://via.placeholder.com/140x80';
                                return `
                                <div class="min-w-[140px] w-[140px] cursor-pointer" onclick="openPlayer(${json.replace(/'/g, "\\'")})">
                                    <img src="${thumb}" class="w-full h-20 object-cover rounded-lg bg-gray-200 mb-1">
                                    <p class="text-sm font-medium line-clamp-2 leading-tight">${h.snippet.title}</p>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Subscriptions List -->
                    <div class="mt-4 bg-white p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg">登録チャンネル</h3>
                            <button class="text-blue-600 text-sm font-medium" onclick="setActiveNav('subs')">一覧</button>
                        </div>
                        <div class="flex overflow-x-auto gap-4 hide-scroll">
                             ${subs.length ? '' : '<p class="text-gray-400 text-sm">登録チャンネルはありません</p>'}
                             ${subs.map(s => `
                                <div class="flex flex-col items-center min-w-[70px] cursor-pointer" onclick="renderSearch('${s.title}')">
                                    <img src="${s.thumbnail}" class="w-12 h-12 rounded-full bg-gray-200 mb-1 object-cover">
                                    <p class="text-xs text-center line-clamp-1 w-full">${s.title}</p>
                                </div>
                             `).join('')}
                        </div>
                    </div>

                    <!-- Subscribed Channel Videos -->
                    <div class="mt-4 bg-white">
                        <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                             <h3 class="font-bold text-gray-700">登録チャンネルの最新動画</h3>
                             ${state.economyMode ? '<p class="text-xs text-red-500 mt-1">※API節約モードのため表示されません</p>' : ''}
                        </div>
                        <div id="sub-videos-container" class="min-h-[100px]"></div>
                    </div>
                    
                    <div class="mt-4 bg-white mb-8">
                        <button onclick="renderSettings()" class="w-full text-left p-4 border-b border-gray-100 flex items-center gap-3 ripple">
                            <span class="material-icons text-gray-500">settings</span>
                            <span>設定</span>
                        </button>
                    </div>
                </div>
            `;
            
            if(!state.economyMode && subs.length > 0) {
                const container = document.getElementById('sub-videos-container');
                container.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
                
                const targets = subs.sort(() => 0.5 - Math.random()).slice(0, 3);
                let allVids = [];
                
                for(let sub of targets) {
                    const vids = await API.getChannelVideos(sub.channelId);
                    allVids = [...allVids, ...vids];
                }
                
                container.innerHTML = '';
                if(allVids.length === 0) {
                    container.innerHTML = '<p class="text-center p-4 text-sm text-gray-500">動画を取得できませんでした</p>';
                }
                allVids.forEach(v => container.appendChild(createVideoCard(v, true)));
            } else if (!state.economyMode && subs.length === 0) {
                 document.getElementById('sub-videos-container').innerHTML = '<p class="text-center p-4 text-sm text-gray-500">登録チャンネルがありません</p>';
            }
        }
        
        // 5. Settings Screen
        function renderSettings() {
            closePlayer();
            mainContent.innerHTML = `
                <div class="p-4 bg-white min-h-screen">
                    <div class="flex items-center gap-2 mb-6">
                        <button onclick="renderMyPage()" class="material-icons ripple rounded-full p-2">arrow_back</button>
                        <h2 class="text-xl font-bold">設定</h2>
                    </div>
                    
                    <div class="mb-8 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h3 class="font-bold text-gray-800">API節約モード</h3>
                                <p class="text-xs text-gray-600">ONの場合、検索時以外APIを消費しません</p>
                            </div>
                            <div class="relative inline-block w-12 mr-2 align-middle select-none">
                                <input type="checkbox" name="toggle" id="eco-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300" ${state.economyMode ? 'checked' : ''} onchange="toggleEconomy(this)">
                                <label for="eco-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold mb-2 text-sm">YouTube Data APIキー</h3>
                        <input type="password" id="api-key-input" class="w-full border p-2 rounded mb-2 text-sm bg-gray-50" placeholder="AIzaSy..." value="${state.apiKey}">
                        <button onclick="saveApiKey()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm w-full ripple font-bold">キーを保存</button>
                    </div>

                    <div class="mb-6 border-t pt-4">
                        <h3 class="font-bold mb-4">プロフィール設定</h3>
                        
                        <div class="flex items-center gap-4 mb-4">
                            <img id="setting-preview" src="${state.user.avatar}" class="w-16 h-16 rounded-full object-cover border">
                            <label class="bg-white border border-gray-300 px-3 py-1.5 rounded text-sm cursor-pointer hover:bg-gray-50">
                                画像を選択
                                <input type="file" accept="image/*" class="hidden" onchange="handleAvatarUpload(this)">
                            </label>
                        </div>

                        <input type="text" id="user-name-input" class="w-full border p-2 rounded mb-2 text-sm" placeholder="名前" value="${state.user.name}">
                        <button onclick="saveProfile()" class="bg-theme-red text-white px-4 py-2 rounded shadow-md w-full ripple font-bold">プロフィール更新</button>
                    </div>
                </div>
            `;
        }
        
        function toggleEconomy(el) {
            state.economyMode = el.checked;
            localStorage.setItem('mt_economy_mode', state.economyMode);
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            localStorage.setItem('mt_api_key', key);
            state.apiKey = key;
            alert('APIキーを保存しました');
        }

        async function handleAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('setting-preview').src = e.target.result;
                    state.tempAvatar = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function saveProfile() {
            const name = document.getElementById('user-name-input').value;
            state.user.name = name;
            if(state.tempAvatar) {
                state.user.avatar = state.tempAvatar;
                await db.put('userProfile', { key: 'me', avatar: state.tempAvatar, name: name });
                delete state.tempAvatar;
            } else {
                 await db.put('userProfile', { key: 'me', avatar: state.user.avatar, name: name });
            }
            document.getElementById('header-avatar').src = state.user.avatar;
            alert('プロフィールを更新しました');
        }

        // --- Player Overlay & Logic ---

        async function openPlayer(video) {
            if(!video) return;

            // Robust ID Extraction: Handle API result (id.videoId) vs History/Mock (id as string or obj)
            let vid = null;
            if (typeof video.id === 'string') {
                vid = video.id;
            } else if (video.id && video.id.videoId) {
                vid = video.id.videoId;
            } else if (video.videoId) {
                vid = video.videoId;
            }

            if (!vid) {
                console.error("Video ID not found", video);
                alert("この動画は再生できません（IDエラー）");
                return;
            }

            // Normalization for storage
            const videoToSave = JSON.parse(JSON.stringify(video));
            if(!videoToSave.id) videoToSave.id = { videoId: vid }; // ensure structure
            videoToSave.videoId = vid; // flattening for ease

            // Save History
            await db.put('history', videoToSave);

            // UI Show
            playerOverlay.classList.remove('translate-y-full');
            
            const snip = video.snippet || {};
            const title = snip.title || 'No Title';
            const channel = snip.channelTitle || 'No Channel';
            const cId = snip.channelId || '';
            const desc = snip.description || '';

            // Check Sub Status
            const subs = await db.getAll('subscriptions');
            const isSubscribed = subs.some(s => s.channelId === cId);
            
            // Fetch Comments
            const comments = await API.getComments(vid);

            playerOverlay.innerHTML = `
                <div class="w-full bg-black sticky top-0 z-50">
                     <div class="relative w-full" style="padding-bottom: 56.25%;">
                         <iframe class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/${vid}?autoplay=1&playsinline=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                     </div>
                </div>
                
                <div class="flex-1 overflow-y-auto bg-white relative pb-20">
                    <div class="absolute top-2 right-2 z-10 opacity-50 hover:opacity-100">
                        <button onclick="closePlayer()" class="bg-gray-100 rounded-full p-1"><span class="material-icons text-gray-800">keyboard_arrow_down</span></button>
                    </div>

                    <!-- Info -->
                    <div class="p-3 border-b border-gray-100">
                        <h1 class="text-lg font-bold leading-tight mb-2 pr-8">${title}</h1>
                        <div class="flex items-center text-xs text-gray-600 mb-3">
                            <span>${snip.publishedAt ? timeSince(snip.publishedAt) : ''}</span>
                        </div>
                        
                        <!-- Channel Row -->
                        <div class="flex items-center justify-between mb-4">
                             <div class="flex items-center gap-2">
                                <div class="w-9 h-9 rounded-full bg-gray-300 overflow-hidden">
                                     <img src="https://api.dicebear.com/7.x/identicon/svg?seed=${cId}" class="w-full h-full">
                                </div>
                                <span class="font-bold text-sm truncate max-w-[120px]">${channel}</span>
                            </div>
                            <button id="player-sub-btn" onclick="toggleSubscribe('${cId}', '${channel.replace(/'/g, "\\'")}', 'https://api.dicebear.com/7.x/identicon/svg?seed=${cId}')" 
                                class="${isSubscribed ? 'bg-gray-200 text-gray-800' : 'bg-black text-white'} px-4 py-1.5 rounded-full text-xs font-bold transition-colors">
                                ${isSubscribed ? '登録済み' : 'チャンネル登録'}
                            </button>
                        </div>

                        <!-- Buttons -->
                        <div class="flex justify-around mb-3">
                            <button class="flex flex-col items-center gap-1 text-gray-800" onclick="toggleLike('${vid}')">
                                <span class="material-icons text-xl">thumb_up_off_alt</span>
                                <span class="text-[10px]">高評価</span>
                            </button>
                            <button class="flex flex-col items-center gap-1 text-gray-800" onclick="shareVideo('${vid}')">
                                <span class="material-icons text-xl">share</span>
                                <span class="text-[10px]">共有</span>
                            </button>
                            <button class="flex flex-col items-center gap-1 text-gray-800">
                                <span class="material-icons text-xl">playlist_add</span>
                                <span class="text-[10px]">保存</span>
                            </button>
                        </div>
                        
                        <div class="mt-3 bg-gray-100 rounded p-2 text-xs text-gray-700 whitespace-pre-wrap h-auto max-h-24 overflow-y-auto">
                            ${desc || '説明文はありません'}
                        </div>
                    </div>

                    <!-- Comments -->
                    <div class="p-3">
                        <h3 class="font-bold text-sm mb-3">コメント ${state.economyMode ? '(節約モード中)' : ''}</h3>
                        ${comments.length ? comments.map(c => {
                            const top = c.snippet.topLevelComment.snippet;
                            return `
                            <div class="flex gap-3 mb-4">
                                <img src="${top.authorProfileImageUrl}" class="w-7 h-7 rounded-full bg-gray-200">
                                <div class="flex-1">
                                    <div class="flex items-baseline gap-2 mb-0.5">
                                        <span class="text-xs font-bold text-gray-700">${top.authorDisplayName}</span>
                                    </div>
                                    <p class="text-sm text-gray-800 leading-snug">${top.textDisplay}</p>
                                </div>
                            </div>`;
                        }).join('') : '<p class="text-xs text-gray-400">コメントを表示できません</p>'}
                    </div>
                </div>
            `;
        }

        function closePlayer() {
            playerOverlay.classList.add('translate-y-full');
            setTimeout(() => {
                const frame = playerOverlay.querySelector('iframe');
                if(frame) frame.remove();
            }, 300);
        }

        async function toggleSubscribe(cId, title, thumb) {
            if(!cId) return;
            const subs = await db.getAll('subscriptions');
            const exists = subs.find(s => s.channelId === cId);
            const btn = document.getElementById('player-sub-btn');
            
            if(exists) {
                await db.delete('subscriptions', cId);
                if(btn) {
                    btn.innerText = "チャンネル登録";
                    btn.className = "bg-black text-white px-4 py-1.5 rounded-full text-xs font-bold transition-colors";
                }
            } else {
                await db.put('subscriptions', { channelId: cId, title: title, thumbnail: thumb });
                if(btn) {
                    btn.innerText = "登録済み";
                    btn.className = "bg-gray-200 text-gray-800 px-4 py-1.5 rounded-full text-xs font-bold transition-colors";
                }
            }
        }
        
        async function shareVideo(videoId) {
            const url = `https://www.youtube.com/watch?v=${videoId}`;
            if (navigator.share) {
                try {
                    await navigator.share({ title: 'MouseTube', url: url });
                } catch (err) { console.log('Share canceled'); }
            } else {
                navigator.clipboard.writeText(url).then(() => alert('リンクをコピーしました'));
            }
        }
        
        async function toggleLike(vid) {
            await db.put('likes', { videoId: vid });
            alert('高評価リストに保存しました');
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            if (seconds < 60) return "たった今";
            const intervals = { 年: 31536000, ヶ月: 2592000, 日: 86400, 時間: 3600, 分: 60 };
            for (let [key, val] of Object.entries(intervals)) {
                const count = Math.floor(seconds / val);
                if (count >= 1) return `${count}${key}前`;
            }
            return "たった今";
        }

        // --- Init ---
        window.onload = async () => {
            await db.init();
            const profile = await db.get('userProfile', 'me');
            if(profile) {
                state.user.name = profile.name;
                state.user.avatar = profile.avatar;
                headerAvatar.src = profile.avatar;
            }
            renderHome();
        };

    </script>
</body>
</html>